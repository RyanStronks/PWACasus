<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Game API" />
    <meta name="msapplication-TileColor" content="#6200ee" />
    <meta name="theme-color" content="#6200ee" />
    <link rel="manifest" href="./webmanifest.json" />
    <link
      rel="icon"
      type="image/png"
      href="./assets/favicon-96x96.png"
      sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="./assets/favicon.svg" />
    <link rel="shortcut icon" href="./assets/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./assets/apple-touch-icon.png"
    />
    <meta name="apple-mobile-web-app-title" content="Game API" />
    <title>Home</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link rel="stylesheet" href="./styles.css" />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script defer src="./init.js"></script>
    <script type="module">
      import {
        fetchGames,
        createGame,
        deleteGame,
        uploadImage,
        getGameImageUrl,
      } from './api.js';

      let games = [];
      let gameToDelete = null;

      async function loadGames() {
        try {
          games = await fetchGames();
          renderGames();
        } catch {
          document.getElementById('games-list').innerHTML =
            '<li class="text-red-400">Failed to load games.</li>';
        }
      }

      function renderGames() {
        const list = document.getElementById('games-list');
        if (!games.length) {
          list.innerHTML = '<li class="text-zinc-400">No games found.</li>';
          return;
        }
        list.innerHTML = games
          .map(
            (game) => `
      <li class="p-4 rounded-lg bg-[#1e293b] hover:bg-[#334155] transition-colors border border-[#22304a]">
        <div class="flex items-center justify-between">
          <div>
            <span class="font-semibold text-purple-700 dark:text-purple-400 cursor-pointer hover:underline game-link" data-id="${
              game.id
            }">
              ${game.name}
            </span>
            <span class="ml-2 text-zinc-400">(${game.description})</span>
            ${
              game.image_path
                ? `
              <div class="mt-2">
                <img src="${getGameImageUrl(game.image_path)}" 
                  alt="${game.name}" 
                  class="h-16 w-auto rounded object-cover cursor-pointer game-image"
                  data-img="${getGameImageUrl(game.image_path)}"
                  data-name="${game.name}"
                />
              </div>
            `
                : ''
            }
          </div>
          <div>
            <span class="material-icons cursor-pointer text-red-400 hover:text-red-600 delete-btn" data-id="${
              game.id
            }" data-name="${game.name}">
              delete
            </span>
          </div>
        </div>
      </li>
    `
          )
          .join('');
      }

      function showModal(id) {
        document.getElementById(id).classList.remove('hidden');
      }
      function hideModal(id) {
        document.getElementById(id).classList.add('hidden');
      }

      document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('open-create-modal').onclick = () =>
          showModal('create-modal');
        document.getElementById('cancel-create').onclick = () =>
          hideModal('create-modal');
        document.getElementById('create-form').onsubmit = async function (e) {
          e.preventDefault();
          const form = e.target;
          const name = form.name.value.trim();
          const description = form.description.value.trim();
          const image = form.image.files[0];

          document.getElementById('create-error').classList.add('hidden');
          try {
            let imagePath = '';
            if (image) {
              const data = await uploadImage(image);
              imagePath = data.path || '';
            }
            await createGame({ name, description, image_path: imagePath });
            hideModal('create-modal');
            form.reset();
            await loadGames();
          } catch (err) {
            const errDiv = document.getElementById('create-error');
            errDiv.textContent = err.message || 'Failed to create game.';
            errDiv.classList.remove('hidden');
          }
        };

        document.addEventListener('click', function (e) {
          if (e.target.classList.contains('delete-btn')) {
            gameToDelete = games.find((g) => g.id == e.target.dataset.id);
            document.getElementById('delete-game-name').textContent =
              gameToDelete.name;
            showModal('delete-modal');
          }
        });
        document.getElementById('cancel-delete').onclick = () =>
          hideModal('delete-modal');
        document.getElementById('confirm-delete').onclick = async function () {
          if (!gameToDelete) return;
          try {
            await deleteGame(gameToDelete.id);
            hideModal('delete-modal');
            await loadGames();
          } catch {
            hideModal('delete-modal');
          }
        };

        document.addEventListener('click', function (e) {
          if (e.target.classList.contains('game-image')) {
            document.getElementById('modal-image').src = e.target.dataset.img;
            document.getElementById('modal-image').alt = e.target.dataset.name;
            showModal('image-modal');
          }
        });
        document.getElementById('image-modal').onclick = function (e) {
          if (e.target.id === 'image-modal') hideModal('image-modal');
        };

        loadGames();
      });
    </script>
  </head>

  <body>
    <header class="mdc-top-app-bar">
      <div class="mdc-top-app-bar__row">
        <section
          class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start"
        >
          <button
            class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button"
            aria-label="Open navigation menu"
          >
            menu
          </button>
          <p class="mdc-top-app-bar__title">Game API</p>
        </section>
        <section
          class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end"
          role="toolbar"
        >
          <button
            class="material-icons mdc-top-app-bar__action-item mdc-icon-button"
            aria-label="Search"
            id="search-button"
            type="button"
          >
            search
          </button>
          <div class="mdc-dialog" id="search-dialog">
            <div class="mdc-dialog__container">
              <div
                class="mdc-dialog__surface"
                role="alertdialog"
                aria-modal="true"
                aria-labelledby="search-dialog-title"
                aria-describedby="search-dialog-content"
              >
                <div class="mdc-dialog__content" id="search-dialog-content">
                  <div style="width: 100%; padding: 8px 0">
                    <label
                      class="mdc-text-field mdc-text-field--filled"
                      style="width: 100%"
                    >
                      <span class="mdc-text-field__ripple"></span>
                      <span class="mdc-floating-label" id="search-label"
                        >Searchâ€¦</span
                      >
                      <input
                        class="mdc-text-field__input"
                        type="text"
                        id="search-input"
                        aria-labelledby="search-label"
                        autocomplete="off"
                      />
                      <span class="mdc-line-ripple"></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="mdc-dialog__scrim"></div>
          </div>
        </section>
      </div>
    </header>

    <aside class="mdc-drawer mdc-drawer--modal" id="app-drawer">
      <div class="mdc-drawer__content">
        <nav class="mdc-list">
          <div class="flex item-center justify-center !pt-2 !pb-4">
            <img src="./assets/Game API.svg" alt="Image missing." />
          </div>
          <a
            class="mdc-list-item mdc-list-item--activated hover:bg-gray-200"
            href="#"
            aria-current="page"
            tabindex="0"
          >
            <i class="material-icons mdc-list-item__graphic" aria-hidden="true"
              >inbox
            </i>
            <span class="mdc-list-item__text">Temp</span>
          </a>
          <a
            class="mdc-list-item mdc-list-item--activated !mt-2 hover:bg-gray-200"
            href="#"
            aria-current="page"
            tabindex="0"
          >
            <i class="material-icons mdc-list-item__graphic" aria-hidden="true"
              >inbox
            </i>
            <span class="mdc-list-item__text">Temp</span>
          </a>
          <a
            class="mdc-list-item mdc-list-item--activated !mt-2 hover:bg-gray-200"
            href="#"
            aria-current="page"
            tabindex="0"
          >
            <i class="material-icons mdc-list-item__graphic" aria-hidden="true"
              >inbox
            </i>
            <span class="mdc-list-item__text">Temp</span>
          </a>
        </nav>
      </div>
    </aside>
    <div class="mdc-drawer-scrim"></div>

    <main
      class="main-content min-h-screen bg-gradient-to-b from-white to-purple-100 dark:from-black dark:to-[#923CB5] transition-colors duration-300"
      tabindex="0"
    >
      <div
        class="max-w-2xl mx-auto p-8 rounded-xl shadow-lg bg-gradient-to-br from-[#0f172a] via-[#1e293b] to-[#0a192f] text-zinc-100 mt-8"
      >
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold text-purple-900 dark:text-purple-600">
            Games
          </h1>
          <button
            id="open-create-modal"
            class="px-4 py-2 rounded bg-purple-700 dark:bg-purple-500 text-white hover:bg-purple-800 cursor-pointer"
          >
            + Create Game
          </button>
        </div>
        <ul id="games-list" class="space-y-4 !pt-6"></ul>
      </div>
    </main>

    <!-- Create Game Modal -->
    <div
      id="create-modal"
      class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden"
    >
      <div
        class="bg-[#1e293b] p-6 rounded-lg shadow-lg text-center w-full max-w-md"
      >
        <h2 class="text-xl font-bold text-purple-900 dark:text-purple-600 mb-2">
          Create Game
        </h2>
        <div id="create-error" class="mb-2 text-red-400 hidden"></div>
        <form id="create-form" class="space-y-4">
          <input
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
            placeholder="Name"
            name="name"
            required
          />
          <input
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
            placeholder="Description"
            name="description"
            required
          />
          <input
            type="file"
            accept="image/*"
            name="image"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
          />
          <div class="flex justify-center gap-4 mt-4">
            <button
              type="submit"
              class="px-4 py-2 rounded bg-purple-700 dark:bg-purple-500 text-white hover:bg-purple-800 cursor-pointer"
            >
              Create
            </button>
            <button
              type="button"
              id="cancel-create"
              class="px-4 py-2 rounded bg-zinc-500 text-white hover:bg-zinc-600 cursor-pointer"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Modal -->
    <div
      id="delete-modal"
      class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden"
    >
      <div class="bg-[#1e293b] p-6 rounded-lg shadow-lg text-center">
        <h2 class="text-xl font-bold mb-4 text-blue-200">Are you sure?</h2>
        <p class="mb-6 text-zinc-300">
          Do you really want to delete
          <span id="delete-game-name" class="font-semibold"></span>?
        </p>
        <div class="flex justify-center gap-4">
          <button
            id="confirm-delete"
            class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700"
          >
            Yes, Delete
          </button>
          <button
            id="cancel-delete"
            class="px-4 py-2 rounded bg-zinc-500 text-white hover:bg-zinc-600"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div
      id="image-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm hidden"
    >
      <img
        id="modal-image"
        class="h-1/3 w-2/3 max-w-full max-h-full rounded mb-4 object-contain"
      />

      <p class="absolute bottom-60 left-0 right-0 text-xs text-zinc-300 text-center pointer-events-none">
        Click outside to close
      </p>
  </body>
</html>
